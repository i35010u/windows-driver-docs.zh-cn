---
title: 从低功耗状态快速启动
description: 从低功耗状态快速启动
ms.assetid: 1091571c-2e30-4ad5-b4b9-0f8633e68288
ms.localizationpriority: medium
ms.date: 10/17/2018
ms.openlocfilehash: 8360e3953dd0b858732ba5df02073fa0b161e561
ms.sourcegitcommit: e769619bd37e04762c77444e8b4ce9fe86ef09cb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/31/2020
ms.locfileid: "89189055"
---
# <a name="fast-startup-from-a-low-power-state"></a>从低功耗状态快速启动


若要从低功耗状态快速启动，叶节点设备的驱动程序应处理 S0 电源 IRP (，即 IRP MN 为 S0 系统电源状态的 [** \_ \_ \_ 电源**](./irp-mn-set-power.md) irp) 设置。 设备层次结构中为叶节点的设备没有子设备。 由于叶节点设备在子设备上没有依赖项，因此设备的功能驱动程序可以将设备重新初始化为后台任务，以避免导致操作系统或其他驱动程序的不必要延迟。 与此相反，总线驱动程序有一些依赖项需要额外的同步逻辑来协调开机序列与其子设备。

使用以下步骤可从低功耗状态快速启动叶节点设备：

1.  为 S0 电源 IRP 设置完成例程。

2.  将 S0 电源 IRP 向下发送到设备堆栈。

3.  立即完成 S0 电源 IRP，而不是等待 D0 电源 IRP 完成。 当 S0 power IRP 的完成例程运行时，请执行以下操作：

    1.  请求 D0 电源 IRP (即 **IRP \_ MN \_ 设置 \_ ** d0 设备电源状态的电源 IRP) 。

    2.  将状态 \_ 成功返回到 S0 电源 IRP 的完成例程。

4.  驱动程序应将接收到的任何 i/o 请求排队，但会延迟处理这些请求，直到处理完 D0 power IRP。

5.  当 D0 power IRP 的完成例程运行时，初始化该设备，但将此例程限制为使设备可以使用所需的操作。

6.  完成前面的步骤后，你的驱动程序可以开始处理 i/o 请求，包括可能已排队的任何 i/o 请求。

**注意**   上述步骤不适用于处理 power Irp，使其能够处理除 PowerSystemWorking (S0) 以外的任何电源状态。 这些步骤专门适用于从低功耗状态转换到 (S0) 状态的电源 Irp 的处理。

 

在所有设备都完成其 S0 电源 Irp 后，系统启动已完成。 在系统启动完成时，这些设备不需要完成其 D0 电源 Irp 或完全正常运行。 内核电源管理器具有一组有限的 IRP 调度队列，必须使用这些队列通知系统中的所有设备返回到 S0 状态。 无法快速完成 S0 电源 Irp 的驱动程序会阻止其他设备的驱动程序接收其 S0 电源 Irp。 因此，设计欠佳的驱动程序会导致应并行执行的驱动程序操作影响系统的整体启动性能，同时执行顺序。

驱动程序完成其 S0 电源 IRP 后，它可能会收到来自已打开设备句柄的应用程序发出的 i/o 请求。 驱动程序永远不会失败这些 i/o 请求，因为这样做可能会导致应用程序停止响应并生成超时错误消息。 相反，驱动程序必须将 i/o 请求排队，直到设备准备好对其进行处理。

总线驱动程序可以使用类似于叶节点设备驱动程序中所述的技术，从低功耗状态快速启动。 总线驱动程序必须满足额外的要求，即确保从子设备进入 D0 状态的任何请求都被标记为 "挂起"，并且在总线设备进入 D0 状态之前不会由总线驱动程序完成。

例如，当 USB 集线器的总线驱动程序收到 S0 电源 IRP 时，驱动程序会请求 D0 电源 IRP，并在收到请求的 D0 电源 IRP 后完成 S0 电源 IRP。 但是，S0 电源 IRP 完成后，集线器的子设备可能会开始接收其 S0 电源 irp 并请求 D0 电源 Irp。 总线驱动程序应防止子设备进入 D0，直到集线器设备进入 D0 状态。 因此，总线驱动程序应将所有 D0 电源 Irp 从子设备标记为挂起，并等待完成这些 Irp，直到总线驱动程序处理完集线器的 D0 电源 IRP 并且中心设备完全初始化。

有关 power Irp 的详细信息，请参阅以下主题：

[处理 IRP \_ MN \_ \_ 为系统电源状态设置电源](handling-irp-mn-set-power-for-system-power-states.md)

[处理 IRP \_ MN \_ 设置 \_ 设备电源状态的电源](handling-irp-mn-set-power-for-device-power-states.md)

 

