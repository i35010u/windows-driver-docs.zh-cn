---
title: Windows 存储驱动程序体系结构
description: Windows 存储驱动程序体系结构
ms.assetid: 16636899-fab9-46e8-ab9d-b8d86519b08a
keywords:
- 存储驱动程序 WDK、体系结构
- 存储驱动程序 WDK，类型
ms.date: 10/08/2019
ms.localizationpriority: medium
ms.openlocfilehash: d3dac620c556b587fef571d3a3542f51c456f215
ms.sourcegitcommit: e1ff1dd43b87dfb7349cebf70ed2878dc8d7c794
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 01/02/2020
ms.locfileid: "75606481"
---
# <a name="windows-storage-driver-architecture"></a>Windows 存储驱动程序体系结构

适用于外围存储设备的 Windows 操作系统类和筛选器驱动程序充当类或筛选器驱动程序和系统提供的端口驱动程序上分层的任何中间或高级驱动程序之间的接口。

来自用户应用程序或内核组件的 i/o 请求通过 i/o 系统服务以及一个或多个中间或高级驱动程序（如文件系统驱动程序）来访问存储类驱动程序。 存储类驱动程序在将每个 IRP 发送到下一个较低版本的驱动程序之前，会将它们进入 Irp 的标准 Irp 转换为包含 SCSI 命令描述符块（CDBs）的系统定义的 SCSI 请求块（SRBs）。 存储端口驱动程序将 SRBs 从类驱动程序转换为特定于总线的命令，该命令通过 i/o 总线驱动程序以及可能的一个或多个筛选器驱动程序发送到存储 HBA。

下图显示了 Windows 存储驱动程序的分层体系结构。

![演示基于 nt 的操作系统存储驱动程序的分层体系结构的关系图](images/kg201-1.png)

从图的底部开始，下面介绍了每种类型的存储驱动程序：

1. *存储端口驱动程序*定义了所有 Windows 存储类驱动程序的接口，包括系统提供的磁盘、磁带、CDROM、DVD 和变换器类驱动程序。 此端口/类接口将类驱动程序与其各自设备连接到的主机总线适配器的特定于适配器的要求隔离开来。 对于相应 HBA 上的所有设备驱动程序，存储端口驱动程序还会同步对总线的访问。 系统为 SCSI、IDE、USB 和 IEEE 1394 适配器提供存储端口驱动程序。

    存储端口驱动程序从下一个更高的驱动程序（存储类驱动程序或干预筛选器驱动程序）接收 SRBs，并按如下所示处理它们：

    - SCSI 或其他总线的存储端口驱动程序将 SRBs 与 CDBs 一起传递到与操作系统无关的、特定于 HBA 的*Storport 端口驱动程序，该驱动程序*动态链接到相应的端口驱动程序，并为特定 HBA 提供特定于硬件的支持。 有关实现 SCSI 微型端口驱动程序的信息，请参阅[Storport 微型端口驱动程序](storport-miniport-drivers.md)。
    - 旧 IDE/ATAPI 或 IEEE 1394 总线的存储端口驱动程序将从存储类驱动程序收到的 SRBs 转换为基础适配器所需的格式-例如，根据特定于总线的传输协议重新打包 CDBs，或将其转换为不同的格式，从而将上层驱动程序与基础总线的 peculiarities 分开。

2. 上限或下限*存储筛选器驱动程序*支持特定于设备的功能，而不是由系统提供的存储类驱动程序提供的。 较低版本的筛选器存储驱动程序监视存储类驱动程序所颁发的 SRBs 和/或 Irp，并在将其传递到下一个较低的驱动程序（存储端口驱动程序或其他存储筛选器驱动程序）之前，根据需要进行修改。

    有关实现存储筛选器驱动程序的信息，请参阅[存储筛选器驱动程序](storage-filter-drivers.md)。

3. *存储类驱动程序*使用 SCSI 端口/类接口在系统提供存储端口驱动程序的任何总线上控制其类型的设备。 类驱动程序特定于特定的设备类--例如，一个类驱动程序可以在任何支持的总线上运行所有的 CD-ROM 设备;其他可以控制所有磁盘设备。 存储类驱动程序通过构建包含 CDBs 的 SRBs 处理来自更高存储堆栈中的用户应用程序或驱动程序的 i/o 请求，并将这些 SRBs 发出到下一个较低的驱动程序（存储端口驱动程序或干预筛选器驱动程序），就像设备是 SCSI 设备一样。

    存储类驱动程序的实现对于上层驱动程序是透明的。 磁带或介质转换器设备的类驱动程序实现为设备特定的 miniclass 驱动程序，该驱动程序链接到系统提供的类驱动程序。 系统为其他存储设备提供的类驱动程序，如磁盘和 CD-ROM/DVD，作为单一单一驱动程序实现。

    有关实现存储类驱动程序的信息，请参阅[存储类驱动程序](introduction-to-storage-class-drivers.md)。 有关实现磁带或转换器 miniclass 驱动程序的信息，请分别参阅[磁带驱动](tape-drivers-overview.md)程序和[更换器驱动程序](changer-drivers.md)。

4. 上层筛选器存储驱动程序会从存储堆栈中较高的用户应用程序和驱动程序中截取 Irp，然后在将其传递到下一个较低版本的驱动程序（存储类驱动程序或其他存储筛选器驱动程序）之前对其进行修改。 筛选器驱动程序通常监视基础设备的性能。

设备附加到的总线类型以及其存储端口驱动程序的实现对于上层驱动程序是透明的。 存储端口驱动程序可根据端口/微型端口驱动程序体系结构（如 SCSI 端口驱动程序）实现;作为单一驱动程序，用于控制单个标准硬件，如 IDE/ATAPI 端口驱动程序;或者作为筛选器驱动程序，将 SRBs 转换为不同的驱动程序堆栈（如 IEEE 1394 端口驱动程序）所需的格式。

系统提供的 SCSI 端口驱动程序还可以充当存储类驱动程序与用于控制属于同一类型的非 SCSI 存储设备的 SCSI 微型端口驱动程序之间的接口。 例如，驱动程序编写器可以通过编写链接到系统 SCSI 端口驱动程序并使用其接口的伪 SCSI 微型端口驱动程序来节省相当大的设计、开发和调试工作，而不是为新的磁盘阵列控制器编写驱动程序。提供. 需要使用这种微型端口驱动程序将传入 SCSI 命令转换为特定于设备的命令。 另一方面，系统提供的端口和类驱动程序在代表伪 SCSI 微型端口时处理很必要的工作，包括在初始化期间进行注册表访问、所有资源和对象分配、同步、所请求的 presizing传输以适合微型端口的设备的功能，并重试请求。

有关 SRBs 的更多详细信息，请参阅内核模式驱动程序体系结构参考。 有关 CDBs 的设备类型特定的信息，请参阅 INCITS SCSI-3 标准中的相应命令集。
