---
title: 主时钟
description: 主时钟
ms.assetid: bdd228c1-a15f-4c08-8991-299a3f2e1ee8
keywords:
- 主时钟的 WDK 内核流式处理
- 同步 WDK 内核流式处理
- KSPROPERTY_STREAM_MASTERCLOCK
- 物理时间 WDK 内核流式处理
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 57dfbee5856cd1fd1c0ee23da6e2433c37c249a0
ms.sourcegitcommit: e769619bd37e04762c77444e8b4ce9fe86ef09cb
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 08/31/2020
ms.locfileid: "89187077"
---
# <a name="master-clocks"></a>主时钟





微型驱动程序可以将流同步到由其他微型驱动程序创建的时钟;多个流可以同步到一次时钟。 如果 pin 使用或生成此类 *主时钟*，则微型驱动程序应支持 [**KSPROPERTY \_ STREAM \_ MASTERCLOCK**](./ksproperty-stream-masterclock.md)。 客户端还可以使用此属性设置 pin 的主时钟。 执行渲染和捕获操作的 pin 经常使用主时钟。 微型驱动程序负责在终止时释放时钟引用。

主时钟接口是支持方法、属性和事件的文件对象。

针对文件对象的所有查询仅在被动级别可用 \_ 。 不过，也可以通过调度级别提供的直接函数调用指针来支持时钟位置查询 \_ ，只要文件对象有效，就会有效。 必须将此直接调用作为上下文参数传递到时钟的文件对象。

文件句柄是通过创建请求在筛选器 pin 实例上获取的，很多情况下是通过 IRP MJ create 完成 pin 创建 \_ \_ 。 此请求将导致创建文件句柄，就像创建 pin 的文件句柄一样，并具有自己的上下文信息。 然后，将此文件句柄传递回调用方，并可用于为内核模式筛选器设置主时钟。 当向筛选器分配图形的主时钟时，pin 实例可以查询父文件对象，以确定它是否拥有主时钟。

如果向筛选器提供了此主时钟的文件句柄，则可以使用它来查询属性。 如果主时钟基于内核模式筛选器，则它必须支持接口以查询主时钟的内核模式部分的文件句柄。 如果不支持接口，则假定时钟基于用户模式，并且内核模式筛选器无法与其同步。

然后，请求主时钟句柄的 DirectShow 代理筛选器将其传递到其基础内核模式筛选器文件句柄。 内核模式筛选器引用基础文件对象。 如果筛选器已具有主时钟，它将取消引用文件对象并使用新句柄。 为此，筛选器必须处于 *停止状态*。

主时钟对象上的物理时间通常基于硬件。 如果呈现主时钟的筛选器没有物理时钟，则会根据显示的数据的时间戳进行流式处理。 在这种情况下，由于缺少数据，时间戳可能会停止。

主时钟后的物理时间可能是远程的，在这种情况下，本地代理负责提供准确的读取。 例如，代理负责补偿1394连接上的延迟，或通过网络平均延迟。 此外，如果另一个内核筛选器是同一1394总线上的第二个设备的代理，则这两个设备可能会协商与主时钟建立交互的专用方法。 在这种情况下，设备必须使用专用接口来确定时钟类型以便验证兼容性。

 

