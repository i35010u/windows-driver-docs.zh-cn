---
title: 设备安装期间的自动配置
description: 设备安装期间的自动配置
ms.assetid: 04b53767-4b5e-450d-96ab-b029cdf62b36
keywords:
- 设备安装过程中自动配置 WDK 打印机
- 打印机自动配置 WDK 打印机，在设备安装过程中
ms.date: 04/20/2017
ms.localizationpriority: medium
ms.openlocfilehash: 8caee1e13b68eca2aebff84cc2ea4f26b8297e2b
ms.sourcegitcommit: 4b7a6ac7c68e6ad6f27da5d1dc4deabd5d34b748
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 10/24/2019
ms.locfileid: "72842843"
---
# <a name="autoconfiguration-during-device-installation"></a>设备安装期间的自动配置


下图显示了安装设备时的自动配置中的数据流。

![说明安装设备时在自动配置过程中的数据流的图示](images/autocfginstall.png)

1.  安装打印机时，后台处理程序会通过调用 `DrvPrinterEvent` 并在调用中传递打印机\_事件\_初始化来初始化驱动程序。

2.  该驱动程序使用[双向通信接口](https://docs.microsoft.com/windows-hardware/drivers/ddi/_print/index)获取它所需的数据，包括可安装选项（如 \\DuplexUnit：已安装的和 \\的打印机）的值。

3.  双向通信接口在端口监视器中查询这些属性的值。 端口监视器可能在其缓存中有一些请求的数据。 出于以下步骤中的说明目的，假设 "DuplexUnit：已安装" 的 \\值位于端口监视器的缓存中，但未安装 \\的值。

4.  如果端口监视器具有缓存，并在其中保存了一个或多个请求的值，则端口监视器会将这些值返回到双向通信接口。 对于不在其缓存中的任何值，端口监视器将返回错误，\_没有\_的数据。 请注意，如果端口监视器实现缓存但缓存为空，则双向查询可能会失败。 若要防止出现此问题，端口监视器应在填充缓存时通知双向通信接口。

5.  双向通信接口将从端口监视器接收的信息传递给驱动程序。 如果从双向通信接口到端口监视器的调用由于任何原因而导致失败，则驱动程序应为这些属性设置默认值。 一旦端口监视器接收到请求的属性的相关信息，它就应该向双向通信接口发送包含此信息的通知。

    驱动程序将更新注册表，其值 \\为 "DuplexUnit：已安装（从端口监视器的缓存中获得）" 和 "\\的默认值"。

6.  端口监视器在设备上查询两个值，包括缓存的值（\\安装的）。

7.  设备会将查询的属性值发送到端口监视器。 对于其值不在缓存中的值，或者其值与缓存中的值不同的任何属性，端口监视器会将新值放置在其缓存中。

8.  端口监视器向后台处理程序发送一个通知，其中包含以前不在缓存中或已更改的任何值。 在此示例中，端口监视器向后台处理程序发送有关 \\DuplexUnit：已安装的新值的通知。 请注意，如果缓存的值与从设备接收到的新值相同，则端口监视器不会将通知发送到后台处理程序。

9.  后台处理程序通过调用 `DrvPrinterEvent`，同时传递打印机\_事件\_配置\_更新，并通过调用中所有已更改的值的相关信息，来响应来自端口监视器的通知。 此操作有两个用途：若要通知驱动程序其值首次放入缓存中或其值已更改的任何属性值\\（在本示例中为 DuplexUnit：已安装），为;更新注册表。 对于每个打印机，后台处理程序将其调用序列化到 `DrvPrinterEvent`，以便驱动程序无需是线程安全的。

    由于设备信息存储在注册表中，因此驱动程序可满足更新 UI 或设备功能信息的调用，而无需直接与物理设备通信。 驱动程序可以确定存储在注册表中的信息是正确的，因为更改通知会触发驱动程序来查询设备并更新设备配置状态。

10. 驱动程序根据最新的配置更新 UI。

    驱动程序可以确定设备安装过程中发生更改的时间，因为通知消息携带更改的值。 但是，如果通知太大而无法通过通知机制发送，则通知将有一个或多个 ReducedSchema 实例，其中每个实例都表示设备特征已更改，但没有其新值的任何详细信息。

 

 




