---
title: 筛选数据（以前的版本）
description: 为了优化数据吞吐量，传感器设备必须对数据更新事件应用筛选条件，以便仅在需要时才会引发这些事件。
ms.assetid: 1895EC5C-08C1-4976-83F2-CD5A2B55338D
keywords:
- 更改敏感度
- 传感器更改敏感度
- CS
- 当前报表间隔
- 传感器当前报表间隔
- CRI
- 数据更新事件
- 传感器事件
- 传感器事件
- 筛选数据
- 数据筛选
ms.date: 07/20/2018
ms.localizationpriority: medium
ms.openlocfilehash: d485f6ff82b2f9e2ee79c8ef2ca6e614890eb57a
ms.sourcegitcommit: 9102e34c3322d8697dbb6f9a1d78879147a73373
ms.translationtype: MT
ms.contentlocale: zh-CN
ms.lasthandoff: 07/28/2020
ms.locfileid: "87264263"
---
# <a name="filtering-data-previous-version"></a>筛选数据（以前的版本）


为了优化数据吞吐量，传感器设备必须对数据更新事件应用筛选条件，以便仅在需要时才会引发这些事件。 此筛选将导致 CPU 使用率降低（因传感器吞吐量降低而降低），并且降低功耗（传感器和 CPU）。

有两个值（或属性）支持传感器设备的筛选条件。 第一个是当前报表间隔（CRI），第二个是更改敏感度（CS）。 这两个属性都可以由传感器应用程序设置。

当前报表间隔是客户端希望在有意义的更改时接收的数据更新之间的最短时间（以毫秒为单位）。 更改敏感度是用于指定有意义的更改的值（或百分比）。

因此，天气应用程序可以为60000（或一分钟）温度传感器指定当前报表间隔（CRI）。 温度传感器需要更改敏感度值（而非百分比）。 例如，如果此温度传感器返回摄氏温度，而更改敏感度值温度为2.0，则当温度增加或2.0 降低到超过请求的报告间隔（在本例中为一分钟）时，此特定传感器将仅引发数据更新事件。

环境光线传感器（ALS）是一个传感器的示例，需要将更改敏感度指定为百分比。 例如，如果 Illuminance 的更改敏感度值为2.0，此传感器会将值解释为百分比，并且仅当 LUX 值已删除或增加2% 时才会引发数据更新事件。

下表列出了六个常见传感器、与每个传感器相关联的数据，以及相应的更改敏感度。

| 传感器             | Datafield              | 更改敏感度值           |
|--------------------|------------------------|------------------------------------|
| 光传感器       | LUX                    | lux 中的更改百分比                    |
| 加速计      | 加速度 X         | 加速 G-force               |
|                    | 加速 Y         | 加速 G-force               |
|                    | 加速 Z         | 加速 G-force               |
| 三维陀螺测试仪       | 角度速度 X        | 角度速度（每秒度） |
|                    | 角度速度 Y        | 角度速度（每秒度） |
|                    | 角度速度 Z        | 角度速度（每秒度） |
| 指南针            | 磁性北部标题 | 度                            |
|                    | True 北部标题     | 度                            |
| 测斜仪       | Yaw                    | 度                            |
|                    | 音调                  | 度                            |
|                    | Roll                   | 度                            |
| 设备方向 | 四元             | 度变动                   |
|                    | 旋转矩阵        | 度变动                   |

 

下表列出了建议的当前报表间隔（CRI）默认值。

| 传感器类型   | 推荐的默认报表间隔 |
|---------------|-------------------------------------|
| 环境光线 | 5000                                |
| 加速计 | 100                                 |
| 陀螺测试仪     | 100                                 |
| 指南针       | 100                                 |
| 测斜仪  | 50                                  |
| 方向   | 50                                  |

 

下表列出了建议的更改敏感度（CS）默认值。

|  传感器类型  | 建议的默认更改敏感度 |
|---------------|----------------------------------------|
| 环境光线 | 50                                     |
| 加速计 | 0.02                                   |
| 陀螺测试仪     | 0.50                                   |
| 指南针       | 0.20                                   |
| 测斜仪  | 0.50                                   |
| 方向   | 0.50                                   |


## <a name="change-sensitivity-cs-for-the-inclinometer-and-orientation-sensors"></a>倾斜仪和方向传感器的更改敏感度（CS）


倾斜仪和方向传感器的更改敏感度应计算为两个四元数之间的角度。 从数学上来说，这表示为：

2 \* cos ⁻¹（点积（q1、第2季度））

此计算确保各种平板电脑（或设备）方向的一致性。

## <a name="effective-current-report-interval-cri-and-change-sensitivity-cs"></a>有效的当前报表间隔（CRI）和更改敏感度（CS）


多个应用程序可以为给定的传感器设置当前报表间隔（CRI）和更改敏感度（CS）属性。 驱动程序负责确定应用哪个请求的属性。 驱动程序设置的属性称为有效的当前报表间隔（CRI）和有效的更改敏感度（电子 CS）。

## <a name="setting-the-e-cri-and-e-cs-for-client-applications"></a>设置客户端应用程序的 CRI 和电子 CS


当客户端应用程序建立与传感器的连接时，驱动程序需要设置 CRI 和 E-CS 值。 这些值存储在称为客户端容器的内容中。 下表列出了一个传感器驱动程序所支持的六种方法，并指定了你的驱动程序应使用其客户端容器和 CRI 和电子 CS 属性完成的操作。

<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody>
<tr class="odd">
<td>相关事件</td>
<td>事件处理程序活动</td>
</tr>
<tr class="even">
<td>ISensorDriver::OnClientConnect</td>
<td><p>向客户端容器添加客户端项</p>
<p>根据需要读取默认的 CRI 和 CS 值，并将其存储在客户端容器中</p></td>
</tr>
<tr class="odd">
<td>ISensorDriver：：传感器</td>
<td><p>删除客户端容器中的客户端，并根据其余客户端设置相应的 CRI 和 E-CS</p></td>
</tr>
<tr class="even">
<td>ISensorDriver::OnClientSubscribeToEvents</td>
<td><p>对于相关的传感器，更新 "已订阅事件" 字段（设置为 "true"）。 启用传感器的事件报告。</p></td>
</tr>
<tr class="odd">
<td>ISensorDriver::OnClientUnSubscribeToEvents</td>
<td><p>对于相关的传感器，更新 "已订阅事件" 字段（设置为 false）。 如果没有订阅服务器，请关闭设备的事件报告。</p></td>
</tr>
<tr class="even">
<td>ISensorDriver::OnSetProperties</td>
<td><p>如果设置了 CS 或 CRI 属性，则更新相应的客户端容器字段。</p></td>
</tr>
<tr class="odd">
<td>IFileCallbackCleanup::OnCleanupFile</td>
<td><p>客户端已崩溃或已停止响应。 应该从客户端容器中删除客户端。</p></td>
</tr>
</tbody>
</table>

 

下表显示了带4个连接的客户端应用程序的3D 加速度的客户端容器。 其中两个客户端应用（对应于第2行和第四行）已订阅事件。

| 客户端文件句柄 | 已订阅事件 | CRI | CS （X） | CX （Y） | CS （Z） |
|--------------------|----------------------|-----|--------|--------|--------|
| FF80A267           | FALSE                | 50  | .001   | .001   | .001   |
| FF802489           | TRUE                 | 70  | 02    | 02    | 02    |
| FF80D345           | FALSE                | 15  | Null   | Null   | Null   |
| FF803287           | TRUE                 | 100 | 。005   | 。005   | 。005   |

 

驱动程序对这组已连接的客户端求值后，为电子 CRI 和电子 CS 选择以下值：

-   E-CRI：70ms
-   电子 CS 值：（可以使用最小阈值折叠为单个值）
    -   X:.005
    -   Y:.005
    -   Z：. 005

请注意，在此示例中，由于事件筛选不应用于这些客户端，因此将忽略未设置事件接收器的客户端（第一个和第三个行）。

## <a name="filtering-data-update-events-by-evaluating-the-effective-cri-and-cs-values-e-cri-e-cs"></a>通过计算有效的 CRI 和 CS 值来筛选数据更新事件（E-CRI，E-CS）


在当前的电子 CRI 和电子 CS 值已确定并且更新为传感器连接状态更改后，传感器设备将使用这些值来筛选引发到连接的客户端应用程序的事件。 将这些值与 "当前" 数据值和之前的数据值之间的差异进行比较。 如果在等于或大于 E-CRI 的时间段内超过了 E-CS 值，则应引发数据事件。 此情况的唯一例外是当应用默认值以便客户端可以接收正确的通知时，传感器设备启动。

下图演示了如何评估原始传感器数据的时间筛选，以便确定何时应引发数据事件。

![时间筛选的传感器数据](images/cri-cs.png)

在上图中，关系图下半部分的红色数据表示原始传感器数据。 绿线表示将返回到轮询数据的客户端的数据（多个实现此行为的方式之一），而 "X" 值表示触发数据事件的时间。 蓝线是电子 CS 边界（+/-E-CS 相对于最后一个数据事件值）的阈值。

通过实现此事件筛选逻辑，可大大减少更新的数据事件数，并且当传感器数据发生有意义的更改时，应用程序仍会收到通知。

## <a name="device-runtime-optimizations-for-data-filtering"></a>用于数据筛选的设备运行时优化


本部分介绍开发传感器驱动程序时应考虑的几个运行时优化。

### <a name="support-interrupts"></a>支持中断

驱动程序应依赖于中断，而不是轮询设备。 这将导致性能和电源管理的改进。 这些改进包括以下各项。

1.  你的设备可以根据当前的更改敏感度和报表间隔输入较低的电源状态。
2.  使用中断将减少驱动程序和传感器固件中不必要的代码执行。
3.  使用中断将减少总线活动。

**注意**   如果驱动程序依赖于中断，但驱动程序中存在当前报表间隔和更改敏感性逻辑，则驱动程序可能会在数据更新之间收到大量的中断。 因此，在当前报表间隔过期之前，驱动程序可能需要禁用（或屏蔽）中断。

 

### <a name="move-change-sensitivity-support-to-the-device"></a>将更改敏感度支持移到设备

如果传感器硬件或固件支持阈值检测，则应使用此功能来支持更改敏感度。 通过将支持转移到设备，然后响应相应的中断，可减少驱动程序的处理开销。

### <a name="move-report-interval-support-to-the-devices"></a>将报表间隔支持移动到设备

如果传感器硬件或固件支持报表间隔的概念，则应使用此功能。

如果你的传感器不提供本机报表间隔支持，请考虑对当前报表间隔的子集禁用中断。 然后，在此时间过后，检索当前设备数据。

## <a name="related-topics"></a>相关主题
[传感器地理位置驱动程序示例](https://docs.microsoft.com/windows-hardware/drivers/gnss/sensors-geolocation-driver-sample)



